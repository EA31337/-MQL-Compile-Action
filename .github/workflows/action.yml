---
name: Action

on:
  - pull_request
  - push

jobs:
  Windows:
    needs: Linux
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: pip
      - run: pip3 install -r requirements.txt
      - name: Install platform
        continue-on-error: true
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: platform-install.yml
          configuration: |
            [defaults]
            nocows = false
            stdout_callback = yaml
          directory: ./ansible
          options: |
            --connection local
            --inventory localhost,
            --verbose
          requirements: galaxy-requirements.yml
      - name: Run local action (syntax only)
        uses: ./
        with:
          include: tests
          syntax-only: true
          verbose: true
      - name: Run local action (compile)
        uses: ./
        with:
          include: tests
          verbose: true
      - name: Print compiled files
        run: '(Get-ChildItem -Recurse -Path . -Include *.ex[45]).fullname'
        shell: powershell
  Linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install platform
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: platform-install.yml
          configuration: |
            [defaults]
            nocows = false
            stdout_callback = yaml
          directory: ./ansible
          options: |
            --connection local
            --inventory localhost,
            --verbose
          requirements: galaxy-requirements.yml
      - name: Run local action (syntax only)
        uses: ./
        with:
          include: tests
          mt-path: .wine/drive_c
          syntax-only: true
          verbose: true
      - name: Run local action (compile)
        uses: ./
        with:
          include: tests
          verbose: true
